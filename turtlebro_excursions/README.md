# Пакет робота экскурсовода turtlebro_excursion для робота TurtleBro

Пакет предназначен для работы робота TurtleBro с комплектом расширения для сборки полезной нагрузки "Робот-экскурсовод".

С этим пакетом возможна работа робота в трех режимах:
1. Робот озвучивает текст привязанный к точкам патрулирования;
2. Робот озвучивает текст привязанный к точкам патрулирования, а также в случае нахождения в этих точках Aruco-маркеров, озвучиваение текста привязанного к ID-маркера.
3. Робот, после нажатия кнопки подключенной к пину А12, озвучивает температуру с тепловизор, а также озвучивает текст привязанного к ID aruco-маркеров, в случае их нахождения в точках патрулирования. Подробнее про этот режим тут: [Работа пакета экскурсовода с тепловизором и кнопкой](#работа-пакета-экскурсовода-с-тепловизором-и-кнопкой)


## Установка пакета

Пакет входит в сборку метапакета `turtlebro_extra` и устанавливается автоматически при установке этого пакета. Для установки метапакета на роботе выполните команды:

```
cd ~/catkin_ws/src
git clone https://github.com/voltbro/turtlebro_extra
cd ../
catkin_make
```

### Настройка пакета

Для настроек точек патрулирования и фраз при распозновании Aruco-маркеров используются следующие файлы:

1. Файл с описанием точек патрулирования ```data/goals.toml```, также в файл дополнен фразами для озвучивания в точках патрулирования.

2. Файл с описанием Aruco-маркеров ```data/aruco_text.toml```

## Работа пакета в простом режиме экскурсовода

### Запуск пакета

Запуск ноды патрулирования и режима, в которой робот озвучивает по координатам точки патрулирования:
```
roslaunch turtlebro_excursions excursion.launch
```
Запуск ноды патрулирования и режима, в которой робот считывает и озвучивает Aruco-маркеры:
```
roslaunch turtlebro_excursions excursion_aruco.launch
```

Для отладки, возможно запускать пакет в режиме эмуляции патрулирования:
```
roslaunch turtlebro_excursions excursion.launch fake_move_base:=true
```

### Запуск экскурсовода

Пакет наследует функции патрулирования ```turtlebro_patrol```. Для начала движения робота необходимо вызвать сервис ```/patrol_control```:

```
rosservice call /patrol_control "command: 'start'"
```

## Работа пакета экскурсовода с тепловизором и кнопкой

Этот пакет позволяет запускать различные ноды для робота-экскурсовода.

Нода "heat_sensor" позволяет TurtleBro получать данные от тепловизора GridEYE 8x8 AMG88xx. При обнаружении источника тепла с температурой, превышающей пороговую (вы можете настроить этот параметр в файле запуска), нода отправляет значение True в топик /heat_sensor_output.

Нода "auto_detect_server" позволяет TurtleBro работать с видеопотоком камеры и распознавать aruco-маркеры.

Нода "heat_speaker" позволяет TurtleBro озвучивать измеренную температуру и управлять перемещением.

Нода "excursion_point_service" позволяет TurtleBro реализовать функцию, при которой робот озвучивает текст, который заложен в ID распознанного aruco-маркера

### Необходимое оборудование

Робот TurtleBro

Тепловизор: AMG88xx thermal sensor

Концевой выключатель (без фиксации)

Стерео-акустическая система

### Подключение тепловизора

Тепловизор AMG88xx должен быть подключен к встроенному контроллеру, совместимому с arduino, по протоколу I2C. Провода от контактов AMG88XX необходимо подключить к одному из белых разъемов A8-A11 или A13-A15 на плате TurtleBoard.

Документация на датчик:  
https://cdn.sparkfun.com/assets/4/1/c/0/1/Grid-EYE_Datasheet.pdf  
https://cdn-learn.adafruit.com/downloads/pdf/adafruit-amg8833-8x8-thermal-camera-sensor.pdf  

Обозначение проводов:  

AMG88XX pins -> Turtlebro pin  
VIN -> 5V  
GND -> GND  
SDA -> SDA  
SCL -> SCL  

Пример подключения AMG88xx к Arduino:  
https://learn.adafruit.com/adafruit-amg8833-8x8-thermal-camera-sensor/arduino-wiring-test  


### Подключение концевого выключателя

Пин концевого выключателя "NC" должен быть подключен строго к выводу с маркировкой "GPIO" в белом разъеме, обозначенном как "A12".   
Пин концевого выключателя "GND" должен быть подключен к выводу "GND" на том же разъеме, обозначенном как "A12".  
Пин концевого выключателя "VCC" должен быть подключен к выводу "5V" на том же разъеме, обозначенном как "A12".

### Подключение стерео-акустическая система

Чтобы установить колонки, установите верхнюю монтажную площадку на робота. Подключите колонку следующим образом:

USB-кабель колонки -> к USB-порту Raspberry Pi

Аудиокабель колонки -> к аудиопорту Raspberry Pi

### Установка скетча на Arduino

 - Установите Arduino IDE: https://www.arduino.cc/en/main/software  
 - Откройте Arduino Library Manager, найдите в строке поиска библиотеку Adafruit AMG88xx и установите ее. Вы также можете загрузить ее напрямую с https://github.com/adafruit/Adafruit_AMG88xx  
 - Сгенерируйте на роботе библиотеку ros_lib и скопируйте её в папку с библиотеками Arduino на компьютере: https://manual.turtlebro.ru/plata-turtleboard/arduino#biblioteka-arduino-ros_lib
 - Откройте файл turtlebro_excursions/arduino/amg88xx_lm_main/amg88xx_lm_main.ino из этого репозитория в Arduino IDE.
 - Подключите плату TurtleBoard к компьютеру через micro-USB и загрузите в него скрипт.(или загрузите удаленно)

После загрузки вы должны увидеть топики "/amg88xx_pixels" и "/limit_switch" в списке топиков ros.

### Запуск пакета экскурсовода с тепловизором и кнопкой

Перед запуском вы должны очистить данные одометрии, отправив команду сброса:

```
rosservice call /reset
```
Чтобы запустить пакет, используйте следующую команду:
```
roslaunch turtlebro_excursions heat_excursion_aruco.launch
```
Для отладки, возможно запускать пакет в режиме эмуляции патрулирования:
```
roslaunch turtlebro_excursions heat_excursion_aruco.launch fake_move_base:=true
```
### Использование пакета

После запуска вы сможете увидеть следующие топики:

```
/heat_sensor_output
/limit_switch
```

Перед началом экскурсии вам необходимо запустить пакет, дождаться его полного запуска, затем нажать на концевой выключатель на роботе - робот измерит температуру и озвучит ее, после чего экскурсия начнется автоматически. Управление роботом во время экскурсии осуществляется путем отправки сообщения типа: ** std_msgs/String ** в сервис **/patrol_control**. Пример:

```
rosservice call /patrol_control "command: 'pause'" 
```

Допустимые команды:
1. **start** - переключает робота на следующую точку
2. **pause** - приостанавливает экскурсию в любой точке
3. **resume** - возобновляет экскурсию  в любой точке
4. **home** - отправляет в стартовую позицию
5. **shutdown** - останавливает экскурсию  и выключает пакет

Данные о перегреве публикуются в топик ```/heat_sensor_output``` . Настроить параметр ```threshold``` можно в лаунч файле пакета turtlebro_overheat_sensor.

